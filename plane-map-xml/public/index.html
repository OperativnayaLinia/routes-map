<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>–ú–∞—Ä—à—Ä—É—Ç—ã</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
html,body{
height:100%;
margin:0;
font-family:Segoe UI,Roboto,sans-serif;
}

#map{
position:absolute;
inset:0;
}

.controls{
position:absolute;
top:10px;
left:10px;
z-index:1000;
display:none;
gap:6px;
flex-wrap:wrap;
}

.controls button{
padding:8px 12px;
border:none;
border-radius:8px;
background:#0078ff;
color:#fff;
font-weight:600;
cursor:pointer;
}

.controls button.active{
background:#ff9800;
}

.admin-login{
position:absolute;
top:10px;
right:10px;
z-index:1000;
}

.admin-login button{
padding:6px 12px;
border:none;
border-radius:8px;
background:#222;
color:#fff;
cursor:pointer;
}

.dot{
width:14px;
height:14px;
background:red;
border-radius:50%;
box-shadow:0 0 6px rgba(255,0,0,.9);
}

.credit{
position:absolute;
bottom:6px;
left:50%;
transform:translateX(-50%);
background:rgba(0,0,0,.6);
color:#fff;
padding:4px 10px;
border-radius:6px;
font-size:13px;
z-index:1000;
}

@media(max-width:768px){
.controls{
left:50%;
top:6px;
transform:translateX(-50%);
flex-wrap:nowrap;
gap:4px;
}
.controls button{
padding:5px 8px;
font-size:12px;
}
}
</style>
</head>

<body>

<div id="map"></div>

<div class="admin-login">
<button id="loginBtn">–í—Ö–æ–¥ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</button>
</div>

<div class="controls" id="controls">
<button id="start">–°—Ç–∞—Ä—Ç</button>
<button id="pause">–ü–∞—É–∑–∞</button>
<button id="reset">–°–±—Ä–æ—Å</button>
<button id="addPointBtn">‚ûï –¢–æ—á–∫–∞</button>
<button id="editRouteBtn">‚úèÔ∏è –ú–∞—Ä—à—Ä—É—Ç</button>
<button id="deleteRouteBtn">üóë –£–¥–∞–ª–∏—Ç—å</button>
</div>

<div class="credit">
–ü—Ä–æ–≥—Ä–∞–º–º–∞ –æ—Ç —Ç–µ–ª–µ–≥—Ä–∞–º–º –∫–∞–Ω–∞–ª–∞
<a href="https://t.me/Bel_linia_31" target="_blank" style="color:#00b7ff">–ë–µ–ª–≥–æ—Ä–æ–¥—Å–∫–∞—è –û–ø–µ—Ä–∞—Ç–∏–≤–Ω–∞—è –ª–∏–Ω–∏—è</a>
</div>

<script>
/* üîó API Railway */
const API = ""; // <-- –í–°–¢–ê–í–ò–®–¨ –ê–î–†–ï–° RAILWAY

const map=L.map("map").setView([50.5954,36.5873],9);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

const pointIcon=L.divIcon({
html:'<div class="dot"></div>',
className:"",
iconSize:[14,14],
iconAnchor:[7,7]
});

let routes=[];
let activeRoute=null;
let isRunning=false;
let animationFrame=null;
let addPointMode=false;
let editRouteMode=false;
let deleteRouteMode=false;
const speed=0.0004;

/* ===== –ó–ê–ì–†–£–ó–ö–ê ===== */
function loadRoutes(){
fetch(API+"/routes")
.then(r=>r.json())
.then(data=>{
clearMap();
if(!data) return;
data.forEach(r=>{
const poly=L.polyline(r.path,{color:"blue"}).addTo(map);
const marker=L.marker(r.path[0],{icon:pointIcon}).addTo(map);
attachMarkerEvents(marker);
routes.push({path:r.path,polyline:poly,marker,progress:0});
});
});
}

/* ===== –°–û–•–†–ê–ù–ï–ù–ò–ï ===== */
function saveRoutes(){
fetch(API+"/routes",{
method:"POST",
headers:{"Content-Type":"application/json"},
body:JSON.stringify(routes.map(r=>({path:r.path})))
});
}

function clearMap(){
routes.forEach(r=>{
map.removeLayer(r.marker);
map.removeLayer(r.polyline);
});
routes=[];
activeRoute=null;
}

map.on("click",e=>{
if(sessionStorage.getItem("admin")!=="true") return;
if(!addPointMode && !editRouteMode && !e.originalEvent.ctrlKey) return;

const p=[e.latlng.lat,e.latlng.lng];

if(activeRoute){
activeRoute.path.push(p);
activeRoute.polyline.setLatLngs(activeRoute.path);
}else{
const poly=L.polyline([p],{color:"blue"}).addTo(map);
const marker=L.marker(p,{icon:pointIcon}).addTo(map);
const route={path:[p],polyline:poly,marker,progress:0};
routes.push(route);
activeRoute=route;
attachMarkerEvents(marker);
}

saveRoutes();
});

function attachMarkerEvents(marker){
marker.on("click",()=>{
activeRoute=routes.find(r=>r.marker===marker);
if(deleteRouteMode){
deleteRoute(marker);
}
});
}

function deleteRoute(marker){
const r=routes.find(x=>x.marker===marker);
if(!r) return;
map.removeLayer(r.marker);
map.removeLayer(r.polyline);
routes=routes.filter(x=>x!==r);
saveRoutes();
}

function animate(){
if(!isRunning) return;
routes.forEach(r=>{
if(r.path.length<2) return;
const i=Math.floor(r.progress);
const t=r.progress-i;
if(i>=r.path.length-1) r.progress=0;
const a=r.path[i];
const b=r.path[(i+1)%r.path.length];
r.marker.setLatLng([
a[0]+(b[0]-a[0])*t,
a[1]+(b[1]-a[1])*t
]);
r.progress+=speed;
});
animationFrame=requestAnimationFrame(animate);
}

start.onclick=()=>{isRunning=true;routes.forEach(r=>r.progress=0);animate();};
pause.onclick=()=>{isRunning=false;cancelAnimationFrame(animationFrame);};
reset.onclick=()=>{if(confirm("–£–¥–∞–ª–∏—Ç—å –≤—Å—ë?")){clearMap();saveRoutes();}};

addPointBtn.onclick=()=>addPointMode=!addPointMode;
editRouteBtn.onclick=()=>editRouteMode=!editRouteMode;
deleteRouteBtn.onclick=()=>deleteRouteMode=!deleteRouteMode;

loginBtn.onclick=()=>{
if(prompt("–ü–∞—Ä–æ–ª—å:")==="admin"){
sessionStorage.setItem("admin","true");
controls.style.display="flex";
loginBtn.style.display="none";
}
};

if(sessionStorage.getItem("admin")==="true"){
controls.style.display="flex";
loginBtn.style.display="none";
}

/* –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π */
setInterval(()=>{
if(sessionStorage.getItem("admin")!=="true"){
loadRoutes();
}
},5000);

loadRoutes();
</script>

</body>
</html>
